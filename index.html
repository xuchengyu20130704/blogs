<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯ç¬”è®°åº”ç”¨ - Supabase Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 25px; }
        /* Auth UI */
        #auth-ui, #post-form-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input[type="email"], input[type="password"], textarea, input[type="text"] { width: 100%; padding: 10px; margin: 5px 0 15px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #38a169; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background-color: #2f855a; }
        #logged-out-view button { margin-top: 10px; }
        /* Note List */
        #notes-list { list-style: none; padding: 0; }
        .note-item { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .note-title { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .status-message { color: #d97706; margin-top: 10px; }
        .error { color: red; }
    </style>
</head>
<body>

    <div id="auth-ui">
        <h2>ç”¨æˆ·è®¤è¯</h2>
        
        <div id="logged-out-view">
            <p>è¯·ç™»å½•æˆ–æ³¨å†Œä»¥å‘å¸ƒæ–°ç¬”è®°ã€‚</p>
            <input type="email" id="auth-email" placeholder="é‚®ç®±" required>
            <input type="password" id="auth-password" placeholder="å¯†ç " required>
            <button onclick="handleSignIn()">ç™»å½•</button>
            <button onclick="handleSignUp()">æ³¨å†Œ</button>
            <p class="status-message" id="auth-status"></p>
        </div>
        
        <div id="logged-in-view" style="display:none;">
            <p>æ¬¢è¿å›æ¥ï¼Œ<span id="user-email-display"></span>ï¼</p>
            <button onclick="handleSignOut()">ç™»å‡º</button>
        </div>
    </div>

    <div id="post-form-container" style="display:none;">
        <h2>å‘å¸ƒæ–°ç¬”è®°</h2>
        <form id="note-form">
            <input type="text" id="note-title" placeholder="ç¬”è®°æ ‡é¢˜" required>
            <textarea id="note-content" placeholder="ç¬”è®°å†…å®¹" rows="4" required></textarea>
            <button type="submit">å‘å¸ƒç¬”è®°</button>
            <p class="status-message" id="note-status"></p>
        </form>
    </div>

    <h1>ğŸ“ æˆ‘çš„ Supabase ç¬”è®° (å…¬å…±)</h1>
    <ul id="notes-list">
        <li class="loading">æ­£åœ¨åŠ è½½å…¬å…±ç¬”è®°åˆ—è¡¨...</li>
    </ul>

    <script>
        // *** æ‚¨çš„é…ç½®ä¿¡æ¯ (å·²è‡ªåŠ¨å¡«å……) ***
        const SUPABASE_URL = 'https://mmuadyrcrkocezjplnwi.supabase.co';
        // è¯·ä½¿ç”¨æ‚¨è‡ªå·±çš„ Anon Key
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tdWFkeXJjcmtvY2V6anBsbndpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTA2MjQsImV4cCI6MjA4MDA2NjYyNH0.bD-4DlPTJ72HgKO-YG4HV79pVKpQOr4Oec7xpjLLtlw';

        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- è®¤è¯å¤„ç†å‡½æ•° ---

        async function handleSignUp() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const statusEl = document.getElementById('auth-status');
            
            // æ³¨å†Œ
            const { error } = await supabaseClient.auth.signUp({ email, password });
            
            if (error) {
                statusEl.textContent = `æ³¨å†Œå¤±è´¥: ${error.message}`;
                statusEl.classList.add('error');
            } else {
                // æ³¨å†ŒæˆåŠŸåï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥é‚®ä»¶è¿›è¡Œç¡®è®¤
                statusEl.textContent = 'æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±è¿›è¡Œç¡®è®¤ã€‚';
                statusEl.classList.remove('error');
            }
        }

        async function handleSignIn() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const statusEl = document.getElementById('auth-status');

            // ç™»å½•
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                statusEl.textContent = `ç™»å½•å¤±è´¥: ${error.message}`;
                statusEl.classList.add('error');
            } else {
                // ç™»å½•æˆåŠŸï¼ŒçŠ¶æ€å˜åŒ–ç”± onAuthStateChange è‡ªåŠ¨å¤„ç†
                statusEl.textContent = 'ç™»å½•ä¸­...';
                statusEl.classList.remove('error');
            }
        }

        async function handleSignOut() {
            // ç™»å‡º
            await supabaseClient.auth.signOut();
        }

        function handleLogin(user) {
            // æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€å’Œå‘å¸–è¡¨å•
            document.getElementById('logged-out-view').style.display = 'none';
            document.getElementById('logged-in-view').style.display = 'block';
            document.getElementById('post-form-container').style.display = 'block';
            document.getElementById('user-email-display').textContent = user.email;
        }

        function handleLogout() {
            // æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
            document.getElementById('logged-out-view').style.display = 'block';
            document.getElementById('logged-in-view').style.display = 'none';
            document.getElementById('post-form-container').style.display = 'none';
            document.getElementById('auth-status').textContent = 'å·²ç™»å‡ºã€‚';
        }

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ– (å…³é”®ï¼šç”¨äºè‡ªåŠ¨åˆ‡æ¢ UI)
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session) {
                handleLogin(session.user);
            } else {
                handleLogout();
            }
        });

        // --- æ•°æ®æ’å…¥å‡½æ•° (POST/INSERT) ---

        async function createNote(event) {
            event.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º
            
            const title = document.getElementById('note-title').value;
            const content = document.getElementById('note-content').value;
            const statusEl = document.getElementById('note-status');

            statusEl.textContent = 'æ­£åœ¨å‘å¸ƒ...';
            
            try {
                // æ’å…¥æ“ä½œï¼Œåªæœ‰ authenticated ç”¨æˆ·æ‰èƒ½æˆåŠŸ
                const { error } = await supabaseClient
                    .from('notes')
                    .insert([
                        { title: title, content: content }
                    ]);

                if (error) {
                    throw error;
                }

                statusEl.textContent = 'å‘å¸ƒæˆåŠŸï¼æ­£åœ¨åˆ·æ–°åˆ—è¡¨...';
                document.getElementById('note-form').reset(); // æ¸…ç©ºè¡¨å•
                fetchNotes(); // é‡æ–°åŠ è½½ç¬”è®°åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°ç¬”è®°

            } catch (err) {
                console.error('Insert Error:', err);
                statusEl.textContent = `å‘å¸ƒå¤±è´¥: ${err.message}`;
                statusEl.classList.add('error');
            }
        }

        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('note-form').addEventListener('submit', createNote);

        // --- æ•°æ®è¯»å–å‡½æ•° (SELECT/GET) ---

        async function fetchNotes() {
            const listElement = document.getElementById('notes-list');
            
            try {
                // è¯»å–æ“ä½œï¼Œæ‰€æœ‰ anon ç”¨æˆ·éƒ½èƒ½è¯»å–
                const { data: notes, error } = await supabaseClient
                    .from('notes')
                    .select('title, content')
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                listElement.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º

                if (!notes || notes.length === 0) {
                    listElement.innerHTML = '<li style="text-align:center">ğŸ“­ æ•°æ®åº“é‡Œè¿˜æ²¡æœ‰ç¬”è®°ã€‚</li>';
                    return;
                }

                notes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = 'note-item';
                    li.innerHTML = `<div class="note-title">${escapeHtml(note.title)}</div><div class="note-content">${escapeHtml(note.content)}</div>`;
                    listElement.appendChild(li);
                });

            } catch (err) {
                console.error('Fetch Error:', err);
                listElement.innerHTML = `<li class="error">âŒ åŠ è½½å¤±è´¥: ${err.message}. è¯·æ£€æŸ¥æ§åˆ¶å°ã€‚</li>`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // é¡µé¢å¯åŠ¨æ—¶åŠ è½½ç¬”è®°åˆ—è¡¨
        fetchNotes();

    </script>
</body>
</html>
